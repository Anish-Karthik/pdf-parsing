<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parsing Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <style>
      .upload {
        width: 100px;
        height: 30px;
        border-width: 1px;
        border-radius: 6px;
      }
      .header {
        padding: 10px;
        display: grid;
        grid-template-columns: 50% 50%;
        column-gap: 30px;
        height: 200px;
        width: 100%;
        position: fixed;
        background-color: white;
        top: 0;
      }
      html {
        padding: 25px;
        font-size: small;
      }
      .section {
        text-align: center;
        width: 100%;
      }
      .question-no-style {
        background-color: #636467;
        color: white;
        padding: 3px;
        border-radius: 5px;
        font-size: x-small;
        font-weight: 800;
        margin: 3px;
      }
      .up-down-btns {
        display: flex;
        justify-content: space-between;
      }
      #content {
        padding-top: 200px;
        display: grid;
        grid-template-columns: 50% 50%;
        column-gap: 20px;
      }
      .line-of-passage {
        text-align: center;
      }
      a {
        text-decoration: none;
        display: inline;
      }
      .question {
        display: flex;
        justify-content: flex-start;
        column-gap: 10px;
        align-items: start;
      }
      .highlighted {
        font-weight: bold;
        color: #4285f4;
        font-size: small;
      }
      input {
        margin-top: 3px;
        height: 20px;
        width: 20px;
      }
      .question-html,
      .section-html {
        height: 100vh;
        overflow: scroll;
      }
    </style>
  </head>
  <body>
    <div id="content"></div>
    <div class="header">
      <div>
        <div>Modify Question : <span id="selectedQuestionId"></span></div>
        <div>Start Ref : <span id="modifyStartRef"></span></div>
        <div>End Ref : <span id="modifyEndRef"></span></div>
        <button onclick="modifyRef()">ModifyRef</button>
        <button style="margin-left: 30px" onclick="deleteRef()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="15"
            height="15"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-trash"
          >
            <path d="M3 6h18" />
            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
          </svg>
        </button>
      </div>
      <div class="up-down-btns">
        <div>
          <input
            type="file"
            id="fileInput"
            accept=".json"
            placeholder="choose file"
            style="width: 200px; height: 27px"
          />

          <button onclick="uploadFile()" class="upload">
            upload
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="15"
              height="15"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="lucide lucide-upload"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" x2="12" y1="3" y2="15" />
            </svg>
          </button>
        </div>

        <button
          style="
            width: 125px;
            height: 30px;
            border-radius: 6px;
            border-width: 1px;
          "
          id="downloadBtn"
        >
          Download JSON
        </button>
      </div>
    </div>

    <script>
      var helper = {};
      var data = [];
      function downloadJSONFile(data, filename = "data.json") {
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: "application/json" });
        const link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      document
        .getElementById("downloadBtn")
        .addEventListener("click", function () {
          downloadJSONFile(data, "data.json");
        });
      function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const jsonData = JSON.parse(e.target.result);
              data = jsonData;
              renderContent(data);
              document.getElementById("output").textContent = JSON.stringify(
                jsonData,
                null,
                2
              );
            } catch (error) {
              console.log(error); //
            }
          };
          reader.readAsText(file);
        } else {
          alert("No file selected");
        }
      }

      function passageHightlight(startIndex, wordsByLine) {
        startIndex.forEach((item) => {
          let start_word = item.start;
          let end_word = item.end;

          for (let i = 0; i < wordsByLine.length; i++) {
            if (i >= start_word && i <= end_word) {
              if (i == start_word) {
                wordsByLine[
                  i
                ].html = `<span id="${item.referId}" onclick="clickRef(this)">
                        <span class="question-no-style">Q${item.qno} </span>
                      </span>
                      <span class="highlighted" id='${wordsByLine[i].wordId}'> ${wordsByLine[i].word}</span>`;
              } else if (wordsByLine[i].html == "") {
                wordsByLine[
                  i
                ].html = `<span class="highlighted" id='${wordsByLine[i].wordId}'> ${wordsByLine[i].word}</span>`;
              }
            }
          }
        });
        for (let i = 0; i < wordsByLine.length; i++) {
          if (wordsByLine[i].html == "") {
            wordsByLine[
              i
            ].html = `<span id='${wordsByLine[i].wordId}'> ${wordsByLine[i].word}</span>`;
          }
        }
        return wordsByLine;
      }
      function clickRef(element) {
        let referId = element.id;
        data.questions.forEach((question) => {
          question.references.forEach((ref) => {
            if (ref.referId == referId) {
              document.getElementById("selectedQuestionId").innerText =
                question.qno + ". " + question.description;
              document.getElementById("modifyStartRef").innerText =
                ref.start_word;
              document.getElementById("modifyEndRef").innerText = ref.end_word;
              highlight(data.section, ref.start_word, ref.end_word);
              helper.selectedQuestion = question;
              helper.selectedRef = ref;
              helper.element = element;
              return;
            }
          });
        });
      }
      function modifyRef() {
        const selectedElements = logSelectedAttributes();
        if (!selectedElements) {
          alert("No text is selected");
          return;
        }
        if (!helper.selectedRef && helper.element) {
          alert("No reference selected.");
          return;
        }
        let startWord = selectedElements[0].id.split("-")[2];
        let endWord =
          selectedElements[selectedElements.length - 1].id.split("-")[2];
        if (helper.element) {
          helper.selectedRef.start_word = startWord;
          helper.selectedRef.end_word = endWord;
          helper.element = null;
        } else {
          console.log("hello");
          document.getElementById("modifyStartRef").innerHTML = startWord;
          document.getElementById("modifyEndRef").innerHTML = endWord;

          data.questions.forEach((question, ind) => {
            if (question.id === helper.newRefQuestion.id) {
              data.questions[ind].references.push({
                referId:
                  data.section +
                  "-" +
                  1 +
                  "-" +
                  data.questions[ind].references.length,
                start_word: startWord,
                end_word: endWord,
              });
            }
          });
          console.log(data);
          renderContent(data);
        }
        renderContent(data);
      }

      function append_question_box(wordsByLine, references) {
        var startIndex = [];
        references.forEach((item) => {
          let q_no = item.qno;
          item.references.forEach((ref) => {
            startIndex.push({
              qno: q_no,
              referId: ref.referId,
              start: ref.start_word,
              end: ref.end_word,
            });
          });
        });
        startIndex.sort((a, b) => a.start - b.start);
        var html = ``;
        wordsByLine = passageHightlight(startIndex, wordsByLine);
        wordsByLine.forEach((word, wordInde) => {
          html += word.html;
        });
        return `${html}</div>`;
      }

      function passageHtml(data) {
        const references = data.questions
          .map((question) => {
            if (question.references == 0) return;
            return { qno: question.qno, references: question.references };
          })
          .filter((reference) => reference);

        var wordsByLine = data.words;

        wordsByLine = wordsByLine.map((word) => {
          return { html: ``, ...word };
        });
        return append_question_box(wordsByLine, references);
      }

      function optionHtml(question) {
        return question.options
          .map(
            (option, index) =>
              `<p>${String.fromCharCode(65 + index)}. ${option.description}</p>`
          )
          .join("");
      }

      function highlight(section, start, end, timeout = 4000) {
        for (let i = start; i <= end; i++) {
          document.getElementById(`${section}-1-${i}`).style.background =
            "yellow";
        }
        if (timeout > 0) {
          setTimeout(() => {
            for (let i = start; i <= end; i++) {
              document.getElementById(`${section}-1-${i}`).style.background =
                "";
            }
          }, timeout);
        }
      }

      function getQuestionDescriptionHtml(
        section_no,
        questionDescription,
        references
      ) {
        const patterns = [
          /Lines\s+(\d+)\s*-\s*(\d+)/i,
          /Line\s+(\d+)/i,
          /Lines\s+(\d+)\s*and\s*(\d+)/i,
        ];
        let matches = [];

        patterns.forEach((pattern) => {
          let match = pattern.exec(questionDescription);
          if (match) {
            matches.push({
              start: match.index,
              end: match.index + match[0].length,
            });
          }
        });

        if (matches.length === 0) return questionDescription;

        let html = "";
        let ptr = 0;

        for (let i = 0; i < questionDescription.length; i++) {
          if (
            ptr < matches.length &&
            ptr < references.length &&
            i === matches[ptr].start
          ) {
            let startId = `${section_no}1${references[ptr].start_word}`;
            html += `<a onclick="highlight(${section_no},${
              references[ptr].start_word
            },${
              references[ptr].end_word
            })" href='#${startId}'>${questionDescription.slice(
              i,
              matches[ptr].end + 1
            )}</a>`;
            i = matches[ptr].end;
            ptr++;
          } else {
            html += questionDescription[i];
          }
        }
        return html;
      }
      function clickQuestionRef(element) {
        const questionId = element.id;
        element.style.backgroundColor = "yellow";
        data.questions.forEach((question) => {
          if (question.id === questionId) {
            document.getElementById("selectedQuestionId").innerHTML =
              question.qno + ". " + question.description;
            helper.newRefQuestion = question;
          }
        });
        setTimeout(() => {
          element.style.backgroundColor = "";
        }, 1000);
      }

      function questionHtml(data) {
        return data.questions
          .map(
            (question) =>
              `<div>
                      <div class="question">
                          <p><strong id=${
                            question.id
                          } onclick="clickQuestionRef(this)" >Question ${
                question.qno
              }:</strong>
                            ${getQuestionDescriptionHtml(
                              data.section,
                              question.description,
                              question.references
                            )}
                          </p>
                      </div>
                          ${optionHtml(question)}
                    </div>`
          )
          .join("");
      }

      function reRender(data) {
        const contentDiv = document.getElementById("content");
        let html = `<div class="section-html">
                  <h1 class="section">Section: ${data.section}</h1>`;
        html += passageHtml(data);
        html += `<div class="question-html">${questionHtml(data)}
              </div>`;
        contentDiv.innerHTML = html;
      }
      function renderContent(data) {
        // Listen for mouseup event to trigger the function after selection
        document.addEventListener("mouseup", logSelectedAttributes);
        document.addEventListener("dblclick", logSelectedAttributes);

        if (!data) return;
        reRender(data);
      }

      function logSelectedAttributes() {
        const selection = window.getSelection();

        // Check if there's an actual selection
        if (selection.rangeCount > 0 && !selection.isCollapsed) {
          const range = selection.getRangeAt(0);
          const selectedElements = [];

          // Get all elements that intersect with the selected range
          document.querySelectorAll("span").forEach((span) => {
            if (range.intersectsNode(span)) {
              selectedElements.push(span);
            }
          });

          // Log the attributes of selected elements
          return selectedElements;
        }
      }
    </script>
  </body>
</html>
